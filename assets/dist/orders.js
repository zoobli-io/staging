!function(e){"function"==typeof define&&define.amd?define("orders",e):e()}(function(){"use strict";var s={template:"#orders-single",props:{orderId:Number},data(){return{order:null,loading:!0,pending:!1,pricing:null,booking:null,additions:null,fields:null,actions:null,notes:null,state:{showFields:!1,showPricing:!1,showRules:!1}}},created(){this.getOrder(()=>this.loading=!1)},methods:{getOrder(t){this.loading=!0;var e=Voxel_Config.ajax_url+"&action=orders.view";jQuery.get(e,{order_id:this.orderId},e=>{e.success&&(this.order=e.data,this.pricing=this.order.pricing,this.booking=this.order.booking,this.additions=this.order.additions,this.fields=this.order.fields,this.actions=this.order.actions,this.notes=this.order.notes),t(e)})},backToAll(){this.$root.activeOrder=null,Voxel.deleteSearchParam("order_id"),this.$root.orders.length||this.$root.getOrders()},doAction(e){this.pending=!0,jQuery.get(Voxel_Config.ajax_url,{action:"orders."+e,order_id:this.orderId}).always(e=>{e.success?e.redirect_to?window.location.replace(e.redirect_to):this.getOrder(()=>this.pending=!1):(this.pending=!1,Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error"))})}}},i={template:"#orders-create-note",props:{order:Object},data(){return{message:"",files:{label:"Attach images",id:"files",key:"files",value:null,props:{allowedTypes:[],maxCount:3}}}},methods:{postComment(){var e=new FormData,t={message:this.message},t=(this.$refs.commentFiles.onSubmit(t,e),e.append("fields",JSON.stringify(t)),jQuery.param({action:"orders.post_comment",order_id:this.order.orderId}));jQuery.post({url:Voxel_Config.ajax_url+"&"+t,data:e,contentType:!1,processData:!1,success:e=>{e.success?(this.order.notes.push(e.comment),this.message="",this.$refs.commentFiles.files=[],this.$refs.commentForm.blur()):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")}})},cancelComment(){this.$refs.commentForm.blur()}}},r={template:"#create-post-media-popup",props:{multiple:{type:Boolean,default:!0},ignore:{type:Array,default:[]}},emits:["save","blur","open"],data(){return{page:1,files:[],selected:{},active:!1,loading:!0,hasMore:!1,firstLoad:!0}},methods:{getStyle(e){return e.type.startsWith("image/")?`background-image: url('${e.preview}');`:""},selectFile(e){this.selected[e.id]?delete this.selected[e.id]:this.selected[e.id]=e},loadMedia(){var e=Voxel_Config.ajax_url+"&action=list_media&page="+this.page;jQuery.get(e,e=>{this.loading=!1,e.files&&(this.files=this.files.concat(e.files)),this.hasMore=!!e.has_more})},loadMore(){this.loading=!0,this.page++,this.loadMedia()},openLibrary(){this.$emit("open"),this.firstLoad&&this.loadMedia(),this.firstLoad=!1,this.active=!this.active},isImage(e){return e.type.startsWith("image/")},save(){this.active=!1,this.$emit("save",this.selected),this.selected={}},clear(){this.selected={}}}},o={template:"#create-post-file-field",props:{field:Object,sortable:{type:Boolean,default:!0}},data(){return{accepts:""}},created(){null===this.field.value&&(this.field.value=[]),this.accepts=Object.values(this.field.props.allowedTypes).join(", ")},mounted(){this.updatePreviews(),jQuery(this.$refs.input).on("change",e=>{for(var t=0;t<e.target.files.length;t++){var s=e.target.files[t],i=URL.createObjectURL(s);this.field.value.push({source:"new_upload",name:s.name,type:s.type,preview:i,item:s})}this.$refs.input.value="",this.updatePreviews()}),jQuery(()=>{var e=jQuery(this.$refs.fileList);this.sortable&&(e.sortable({items:"> .ts-file",helper:"clone",appendTo:this.$el,containment:"parent",tolerance:"intersect",revert:150}),e.on("sortupdate",()=>{var s=[];e.find(".ts-file").each((e,t)=>{s.push(this.field.value[t.dataset.index])}),this.field.value=s,this.updatePreviews()})),e.find(".pick-file-input").on("click",e=>{e.preventDefault(),this.$refs.input.click()})})},unmounted(){setTimeout(()=>{Object.values(this.field.value).forEach(e=>{"new_upload"===e.source&&URL.revokeObjectURL(e.preview)})},10),this.sortable&&jQuery(this.$refs.fileList).sortable("destroy")},methods:{getStyle(e){return e.type.startsWith("image/")?`background-image: url('${e.preview}');`:""},updatePreviews(){var e=jQuery(this.$refs.fileList),i=[];this.field.value.forEach((e,t)=>{var s=e.type.startsWith("image/"),s=jQuery(`
					<div class="ts-file ${s?"ts-file-img":""}" style="${this.getStyle(e)}" data-index="${t}">
						<div class="ts-file-info">
							<i class="las la-cloud-upload-alt"></i><code></code>
						</div>
						<a href="#" class="ts-remove-file flexify"><i class="las la-times" aria-hidden="true"></i></a>
					</div>
				`);s.find("code").text(e.name),s.find("a").on("click",e=>{e.preventDefault(),this.field.value.splice(t,1),this.updatePreviews()}),i.push(s)}),e.find(".pick-file-input").siblings().remove(),e.append(i)},onMediaPopupSave(e){var t={};this.field.value.forEach(e=>{"existing"===e.source&&(t[e.id]=!0)}),Object.values(e).forEach(e=>{t[e.id]||this.field.value.push(e)}),this.updatePreviews()},onSubmit(t,s){var i=`files[${this.field.id}][]`;t[this.field.key]=[],this.field.value.forEach(e=>{"new_upload"===e.source?(s.append(i,e.item),t[this.field.key].push("uploaded_file")):"existing"===e.source&&t[this.field.key].push(e.id)})}}};window.render_orders=()=>{Array.from(document.querySelectorAll(".ts-orders")).forEach(e=>{var t;e.__vue_app__||((t=Vue.createApp({el:e,mixins:[Voxel.mixins.base],data(){return{orders:[],type:"all",page:1,status:"all",search:"",loading:!0,hasMore:!1,activeOrder:null,activePopup:null,config:{}}},created(){this.config=JSON.parse(this.$options.el.dataset.config),this.config.activeOrder?this.activeOrder=this.config.activeOrder:this.getOrders()},methods:{getOrders(){this.loading=!0;var e=Voxel_Config.ajax_url+"&action=orders.get";jQuery.get(e,{page:this.page,type:this.type,status:this.status,search:this.search},e=>{e.success&&(this.orders=e.data,this.hasMore=e.has_more),this.loading=!1})},setStatus(e){this.status=e,this.page=1,this.getOrders()},setType(e){this.type=e,this.page=1,this.getOrders()},viewOrder(e){this.activeOrder=e,Voxel.setSearchParam("order_id",e)},searchOrders(){this.page=1,this.getOrders()}}})).component("form-popup",Voxel.components.popup),t.component("form-group",Voxel.components.formGroup),t.component("single-order",s),t.component("create-note",i),t.component("booking-details",{template:"#orders-booking-details",props:{order:Object,booking:Object}}),t.component("display-actions",{template:"#orders-display-actions",props:{order:Object,orderDetails:Object}}),t.component("display-note",{template:"#orders-display-note",props:{order:Object,note:Object}}),t.component("subscription-status",{template:"#orders-subscription-status",props:{order:Object,subscription:Object}}),o.template="#orders-file-field",t.component("media-popup",r),t.component("field-file",o),t.mount(e))})},window.render_orders()});
