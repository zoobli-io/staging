!function(e){"function"==typeof define&&define.amd?define("timeline",e):e()}(function(){"use strict";var s={template:"#create-post-media-popup",props:{multiple:{type:Boolean,default:!0},ignore:{type:Array,default:[]}},emits:["save","blur","open"],data(){return{page:1,files:[],selected:{},active:!1,loading:!0,hasMore:!1,firstLoad:!0}},methods:{getStyle(e){return e.type.startsWith("image/")?`background-image: url('${e.preview}');`:""},selectFile(e){this.selected[e.id]?delete this.selected[e.id]:this.selected[e.id]=e},loadMedia(){var e=Voxel_Config.ajax_url+"&action=list_media&page="+this.page;jQuery.get(e,e=>{this.loading=!1,e.files&&(this.files=this.files.concat(e.files)),this.hasMore=!!e.has_more})},loadMore(){this.loading=!0,this.page++,this.loadMedia()},openLibrary(){this.$emit("open"),this.firstLoad&&this.loadMedia(),this.firstLoad=!1,this.active=!this.active},isImage(e){return e.type.startsWith("image/")},save(){this.active=!1,this.$emit("save",this.selected),this.selected={}},clear(){this.selected={}}}},i={template:"#create-post-file-field",props:{field:Object,sortable:{type:Boolean,default:!0}},data(){return{accepts:""}},created(){null===this.field.value&&(this.field.value=[]),this.accepts=Object.values(this.field.props.allowedTypes).join(", ")},mounted(){this.updatePreviews(),jQuery(this.$refs.input).on("change",e=>{for(var t=0;t<e.target.files.length;t++){var s=e.target.files[t],i=URL.createObjectURL(s);this.field.value.push({source:"new_upload",name:s.name,type:s.type,preview:i,item:s})}this.$refs.input.value="",this.updatePreviews()}),jQuery(()=>{var e=jQuery(this.$refs.fileList);this.sortable&&(e.sortable({items:"> .ts-file",helper:"clone",appendTo:this.$el,containment:"parent",tolerance:"intersect",revert:150}),e.on("sortupdate",()=>{var s=[];e.find(".ts-file").each((e,t)=>{s.push(this.field.value[t.dataset.index])}),this.field.value=s,this.updatePreviews()})),e.find(".pick-file-input").on("click",e=>{e.preventDefault(),this.$refs.input.click()})})},unmounted(){setTimeout(()=>{Object.values(this.field.value).forEach(e=>{"new_upload"===e.source&&URL.revokeObjectURL(e.preview)})},10),this.sortable&&jQuery(this.$refs.fileList).sortable("destroy")},methods:{getStyle(e){return e.type.startsWith("image/")?`background-image: url('${e.preview}');`:""},updatePreviews(){var e=jQuery(this.$refs.fileList),i=[];this.field.value.forEach((e,t)=>{var s=e.type.startsWith("image/"),s=jQuery(`
					<div class="ts-file ${s?"ts-file-img":""}" style="${this.getStyle(e)}" data-index="${t}">
						<div class="ts-file-info">
							<i class="las la-cloud-upload-alt"></i><code></code>
						</div>
						<a href="#" class="ts-remove-file flexify"><i class="las la-times" aria-hidden="true"></i></a>
					</div>
				`);s.find("code").text(e.name),s.find("a").on("click",e=>{e.preventDefault(),this.field.value.splice(t,1),this.updatePreviews()}),i.push(s)}),e.find(".pick-file-input").siblings().remove(),e.append(i)},onMediaPopupSave(e){var t={};this.field.value.forEach(e=>{"existing"===e.source&&(t[e.id]=!0)}),Object.values(e).forEach(e=>{t[e.id]||this.field.value.push(e)}),this.updatePreviews()},onSubmit(t,s){var i=`files[${this.field.id}][]`;t[this.field.key]=[],this.field.value.forEach(e=>{"new_upload"===e.source?(s.append(i,e.item),t[this.field.key].push("uploaded_file")):"existing"===e.source&&t[this.field.key].push(e.id)})}}},a={template:"#timeline-create-status",props:{status:Object,index:Number},data(){return{pending:!1,message:"",rating:null,files:{label:"Attach images",key:"files",id:"files",value:[],props:{allowedTypes:[],maxCount:3}}}},created(){this.status&&this.setupData(this.status)},methods:{setupData(e){this.message=e.raw_content,this.rating=e.review_score,this.files.value=e.files?.slice()||[]},toggleRating(e){this.rating=this.rating===e.score?null:e.score},publish(){this.pending=!0,this.status&&(this.status._pending=!0);var e=new FormData,t={message:this.message,rating:this.rating},t=(this.$refs.files.onSubmit(t,e),e.append("fields",JSON.stringify(t)),jQuery.param({action:this.status?"timeline.status.edit":"timeline.status.publish",post_id:["post_reviews","post_timeline","post_wall"].includes(this.$root.mode)?this.$root.config.postId:null,status_id:this.status?.id,is_review:"post_reviews"===this.$root.mode?1:null,publish_as_post:"post_timeline"===this.$root.mode?1:null}));jQuery.post({url:Voxel_Config.ajax_url+"&"+t,data:e,contentType:!1,processData:!1}).always(e=>{this.pending=!1,e.success?(this.status?(this.status._pending=!1,this.$root.statuses.list.splice(this.index,1,e.status)):(this.$root.statuses.list.unshift(e.status),this.message="",this.$refs.files.files=[]),this.$refs.popup.blur()):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})},cancel(){this.$refs.popup.blur()}},computed:{popupKey(){return"create-status-"+(this.status?this.status.id:"-new")}}},r={template:"#timeline-create-reply",props:{status:Object,parent:Object,reply:Object,index:Number,showTrigger:{type:Boolean,default:!0}},data(){return{pending:!1,message:""}},created(){this.reply&&this.setupData(this.reply)},methods:{setupData(e){this.message=e.raw_content},publish(){this.pending=!0,this.reply&&(this.reply._pending=!0);var e=new FormData,t={message:this.message},t=(e.append("fields",JSON.stringify(t)),jQuery.param({action:this.reply?"timeline.reply.edit":"timeline.reply.publish",post_id:this.$root.post_id,status_id:this.status.id,parent_id:this.parent?.id,reply_id:this.reply?.id}));jQuery.post({url:Voxel_Config.ajax_url+"&"+t,data:e,contentType:!1,processData:!1}).always(e=>{this.pending=!1,e.success?(this.reply?(this.reply._pending=!1,(this.parent?this.parent.replies:this.status.highlightedReplies&&!this.status.replies.requested?this.status.highlightedReplies:this.status.replies).list.splice(this.index,1,e.reply)):(this.parent?(this.parent.reply_count=e.parent_reply_count,this.parent.replies.list.push(e.reply)):this.status.replies.list.push(e.reply),this.status.reply_count=e.status_reply_count,this.message=""),this.$refs.popup.blur()):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})},cancel(){this.$refs.popup.blur()}},computed:{popupKey(){var e=this.reply?this.reply.key:"new";return`reply:${this.status.id}-${this.parent?.id||0}-`+e}}},l={template:"#timeline-review-score",props:{score:Number},data(){return{rating:this.$root.ratingLevels.find(e=>e.score===this.score)}}},o={template:"#timeline-status-replies",props:{status:Object,parent:Object,replies:Object},created(){this.replies.requested||(this.replies.requested=!0,(!this.parent||null!==this.parent.reply_count)&&(this.parent||null!==this.status.reply_count)?this.getReplies():(this.replies.loading=!1,this.replies.hasMore=!1))},methods:{getReplies(){this.replies.loading=!0,jQuery.get(Voxel_Config.ajax_url+"&action=timeline.status.get_replies",{page:this.replies.page,status_id:this.status.id,parent_id:this.parent?.id}).always(e=>{e.success?(this.replies.list.push(...e.data),this.replies.hasMore=e.has_more):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error"),this.replies.loading=!1})},likeReply(t,e){if(!Voxel_Config.is_logged_in)return Voxel.authRequired();let s=this.$refs[t.key+":likeBtn"];s.classList.toggle("ts-liked"),s.classList.add("vx-pending"),jQuery.get(Voxel_Config.ajax_url+"&action=timeline.reply.like",{reply_id:t.id}).always(e=>{s.classList.remove("vx-pending"),e.success?(t.liked_by_user=e.liked_by_user,t.like_count=e.like_count):(s.classList.toggle("ts-liked"),Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error"))})},deleteReply(t,s){confirm("Are you sure?")&&(t._pending=!0,jQuery.get(Voxel_Config.ajax_url+"&action=timeline.reply.delete",{reply_id:t.id}).always(e=>{t._pending=!1,e.success?(this.replies.list.splice(s,1),this.parent&&(this.parent.reply_count=e.parent_reply_count),this.status.reply_count=e.status_reply_count):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")}))},showReplyBox(e,t){if(!Voxel_Config.is_logged_in)return Voxel.authRequired();e.replies.visible=!0,this.$root.activePopup="reply:"+t.id+"-"+e.id+"-new"}}},n={template:"#timeline-single-status",props:{status:Object,index:Number},methods:{likeStatus(){if(!Voxel_Config.is_logged_in)return Voxel.authRequired();let t=this.$refs.likeBtn;t.classList.toggle("ts-liked"),t.classList.add("vx-pending"),jQuery.get(Voxel_Config.ajax_url+"&action=timeline.status.like",{status_id:this.status.id}).always(e=>{t.classList.remove("vx-pending"),e.success?(this.status.liked_by_user=e.liked_by_user,this.status.like_count=e.like_count):(t.classList.toggle("ts-liked"),Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error"))})},deleteStatus(){confirm("Are you sure?")&&(this.status._pending=!0,jQuery.get(Voxel_Config.ajax_url+"&action=timeline.status.delete",{status_id:this.status.id}).always(e=>{this.status._pending=!1,e.success?this.$root.statuses.list.splice(this.index,1):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")}))}}};window.render_timeline=()=>{Array.from(document.querySelectorAll(".ts-social-feed")).forEach(e=>{var t;e.__vue_app__||((t=Vue.createApp({el:e,mixins:[Voxel.mixins.base],data(){return{config:null,activePopup:null,ratingLevels:[],statusId:null,replyId:null,orderingOptions:[],activeOrder:null,mode:null,statuses:{page:1,loading:!0,hasMore:!1,list:[]}}},created(){var e=JSON.parse(this.$options.el.dataset.config);this.config=e,this.ratingLevels=e.ratingLevels,this.statusId=e.statusId,this.replyId=e.replyId,this.mode=e.mode,this.orderingOptions=e.orderingOptions,1<=this.orderingOptions.length&&(this.activeOrder=this.orderingOptions[0]),this.statusId?this.getSingleStatus():this.getStatuses()},methods:{getStatuses(){this.statuses.loading=!0,jQuery.get(Voxel_Config.ajax_url+"&action=timeline.get",{page:this.statuses.page,order_type:this.activeOrder?.order,order_time:this.activeOrder?.time,order_time_custom:this.activeOrder?.time_custom,mode:this.mode,post_id:this.config.postId,author_id:this.config.authorId}).always(e=>{e.success?(this.statuses.list.push(...e.data),this.statuses.hasMore=e.has_more):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error"),this.statuses.loading=!1})},getSingleStatus(){this.statuses.loading=!0,jQuery.get(Voxel_Config.ajax_url+"&action=timeline.get_status",{status_id:this.statusId,reply_id:this.replyId}).always(e=>{e.success?this.statuses.list.push(e.status):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error"),this.statuses.loading=!1})},setActiveOrder(e){this.activeOrder=e,this.statuses.page=1,this.statuses.loading=!0,this.statuses.hasMore=!1,this.statuses.list=[],this.getStatuses()}},computed:{isSingle(){return null!==this.statusId}}})).component("form-popup",Voxel.components.popup),t.component("form-group",Voxel.components.formGroup),t.component("create-status",a),t.component("create-reply",r),t.component("review-score",l),t.component("status-replies",o),t.component("single-status",n),i.template="#timeline-file-field",t.component("media-popup",s),t.component("field-file",i),t.mount(e))})},window.render_timeline()});
